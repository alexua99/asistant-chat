#!/bin/bash

# ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð° Ñ Cloudflare Ñ‚ÑƒÐ½Ð½ÐµÐ»ÐµÐ¼ (Ð±ÐµÐ· Ñ‚Ð¾ÐºÐµÐ½Ð°)

echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð° Ñ Cloudflare Ñ‚ÑƒÐ½Ð½ÐµÐ»ÐµÐ¼"
echo ""

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° cloudflared
if ! command -v cloudflared &> /dev/null; then
    echo "âŒ cloudflared Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
    echo "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ ÐµÐ³Ð¾:"
    echo "  wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O /usr/local/bin/cloudflared"
    echo "  chmod +x /usr/local/bin/cloudflared"
    exit 1
fi

# Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð° Ð² Ñ„Ð¾Ð½Ðµ
echo "Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð° Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ 3000..."
npm start &
SERVER_PID=$!

# Ð–Ð´ÐµÐ¼ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑÐµÑ€Ð²ÐµÑ€ ÑƒÑÐ¿ÐµÐ» Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒÑÑ
sleep 2

echo ""
echo "âœ… Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ (PID: $SERVER_PID)"
echo ""
echo "ðŸŒ Ð—Ð°Ð¿ÑƒÑÐº Cloudflare Ñ‚ÑƒÐ½Ð½ÐµÐ»Ñ..."
echo "   (Ð‘ÐµÐ· Ñ‚Ð¾ÐºÐµÐ½Ð°, Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ URL Ð±ÑƒÐ´ÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸)"
echo ""
echo "=========================================="
echo "Ð’Ð°Ñˆ ÑÐµÑ€Ð²ÐµÑ€ Ð±ÑƒÐ´ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ URL, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð¿Ð¾ÑÐ²Ð¸Ñ‚ÑÑ Ð½Ð¸Ð¶Ðµ"
echo "URL Ð±ÑƒÐ´ÐµÑ‚ Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ: https://xxxxx.trycloudflare.com"
echo "=========================================="
echo ""

# Ð—Ð°Ð¿ÑƒÑÐº Ñ‚ÑƒÐ½Ð½ÐµÐ»Ñ Ð‘Ð•Ð— ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Ð¸ Ð‘Ð•Ð— Ñ‚Ð¾ÐºÐµÐ½Ð°
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ --url Ð´Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ñ‚ÑƒÐ½Ð½ÐµÐ»Ñ
# ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ñ€ÑƒÑŽÑ‚ Ñ‡Ñ‚Ð¾ Ð½Ðµ Ð±ÑƒÐ´ÑƒÑ‚ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒÑÑ ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð¸
echo "Ð—Ð°Ð¿ÑƒÑÐº Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ñ‚ÑƒÐ½Ð½ÐµÐ»Ñ (Ð±ÐµÐ· Ñ‚Ð¾ÐºÐµÐ½Ð° Ð¸ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸)..."
unset CLOUDFLARED_CONFIG_PATH
cloudflared tunnel --url http://localhost:3000 2>&1 | while IFS= read -r line; do
    # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð²ÑÐµ ÑÑ‚Ñ€Ð¾ÐºÐ¸
    echo "$line"
    
    # Ð•ÑÐ»Ð¸ Ð½Ð°Ð¹Ð´ÐµÐ¼ URL - Ð²Ñ‹Ð´ÐµÐ»ÑÐµÐ¼ ÐµÐ³Ð¾
    if [[ "$line" == *"trycloudflare.com"* ]]; then
        echo ""
        echo "=========================================="
        echo "âœ… Ð’ÐÐ¨ ÐŸÐ£Ð‘Ð›Ð˜Ð§ÐÐ«Ð™ URL:"
        echo "$line" | grep -o 'https://[^ ]*trycloudflare.com[^ ]*' | head -1
        echo "=========================================="
        echo ""
    fi
done

# ÐŸÑ€Ð¸ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐµ (Ctrl+C) - Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ð¼ ÑÐµÑ€Ð²ÐµÑ€
trap "kill $SERVER_PID 2>/dev/null" EXIT

