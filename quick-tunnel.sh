#!/bin/bash

# ÐœÐ°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹ Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ Ñ‚ÑƒÐ½Ð½ÐµÐ»ÑŒ Ð‘Ð•Ð— Ñ‚Ð¾ÐºÐµÐ½Ð°
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ: npm run quick-tunnel

echo "ðŸš€ Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ Cloudflare Ñ‚ÑƒÐ½Ð½ÐµÐ»ÑŒ (Ð‘Ð•Ð— Ð¢ÐžÐšÐ•ÐÐ)"
echo ""

if ! command -v cloudflared &> /dev/null; then
    echo "âŒ cloudflared Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
    exit 1
fi

echo "Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°..."
npm start &
SERVER_PID=$!
sleep 3

echo ""
echo "âœ… Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½"
echo ""
echo "ðŸŒ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ð¾Ð³Ð¾ URL (Ð±ÐµÐ· Ñ‚Ð¾ÐºÐµÐ½Ð°)..."
echo ""
echo "=========================================="
echo "âš ï¸  Ð’ÐÐ˜ÐœÐÐÐ˜Ð•: ÐŸÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ URL Ð¿Ð¾ÑÐ²Ð¸Ñ‚ÑÑ Ð½Ð¸Ð¶Ðµ!"
echo "Ð˜Ñ‰Ð¸Ñ‚Ðµ ÑÑ‚Ñ€Ð¾ÐºÑƒ Ñ 'https://' Ð¸ 'trycloudflare.com'"
echo "=========================================="
echo ""

# Ð¡Ð°Ð¼Ñ‹Ð¹ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹ ÑÐ¿Ð¾ÑÐ¾Ð± - Ñ‚Ð¾Ð»ÑŒÐºÐ¾ --url, Ð½Ð¸Ñ‡ÐµÐ³Ð¾ Ð±Ð¾Ð»ÑŒÑˆÐµ
cloudflared tunnel --url http://localhost:3000 2>&1 | while IFS= read -r line; do
    echo "$line"
    
    # Ð’Ñ‹Ð´ÐµÐ»ÑÐµÐ¼ URL ÐºÐ¾Ð³Ð´Ð° Ð½Ð°Ð¹Ð´ÐµÐ¼
    if echo "$line" | grep -q "trycloudflare.com"; then
        URL=$(echo "$line" | grep -o 'https://[^ ]*\.trycloudflare\.com')
        if [ ! -z "$URL" ]; then
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âœ… Ð’ÐÐ¨ ÐŸÐ£Ð‘Ð›Ð˜Ð§ÐÐ«Ð™ URL:"
            echo "   $URL"
            echo ""
            echo "ðŸŒ ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ ÑÑ‚Ñƒ ÑÑÑ‹Ð»ÐºÑƒ Ð² Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ðµ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
        fi
    fi
done

# ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð° Ð¿Ñ€Ð¸ Ð²Ñ‹Ñ…Ð¾Ð´Ðµ
trap "kill $SERVER_PID 2>/dev/null" EXIT

